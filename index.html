<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Garlic Orbit Shooter</title>
  <style>
    :root { color-scheme: dark; }
    * { box-sizing: border-box; }
    body{
      margin:0;
      min-height:100vh;
      display:grid;
      place-items:center;
      background: radial-gradient(1200px 800px at 50% 20%, #182a66 0%, #070a12 55%, #02030a 100%);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      user-select:none;
      -webkit-user-select:none;
      touch-action:none;
      overflow:hidden;
    }
    .wrap{ width:min(980px, 100vw); padding:12px; position:relative; }
    canvas{
      width:100%;
      height:auto;
      aspect-ratio:16/9;
      display:block;
      border-radius:18px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.18);
      box-shadow: 0 18px 70px rgba(0,0,0,0.55);
    }
    .hint{
      margin-top:10px;
      opacity:0.8;
      font-size:14px;
      line-height:1.35;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:space-between;
    }
    .kbd{
      padding:3px 8px;
      border-radius:9px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.08);
    }

    /* Nickname + Leaderboard overlay */
    .overlay {
      position:absolute;
      inset: 12px;
      display:none;
      align-items:center;
      justify-content:center;
      pointer-events:auto;
    }
    .overlay.show { display:flex; }
    .panel{
      width:min(720px, 92vw);
      background: rgba(0,0,0,0.55);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 18px;
      padding: 16px;
      backdrop-filter: blur(8px);
      box-shadow: 0 20px 80px rgba(0,0,0,0.55);
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 14px;
    }
    @media (max-width: 720px){
      .panel{ grid-template-columns: 1fr; }
    }
    .title{
      font-size: 28px;
      font-weight: 900;
      letter-spacing: .5px;
      margin: 0 0 6px 0;
    }
    .sub{
      margin: 0 0 12px 0;
      opacity: .85;
      line-height: 1.35;
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input{
      flex: 1;
      min-width: 180px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
      color:#fff;
      font-weight: 700;
      outline: none;
    }
    button{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.10);
      color:#fff;
      font-weight: 900;
      cursor:pointer;
    }
    button:active { transform: translateY(1px); }
    .lb{
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      padding: 12px;
      background: rgba(255,255,255,0.06);
    }
    .lb h3{
      margin:0 0 10px 0;
      font-size: 16px;
      letter-spacing: .4px;
    }
    .lb ol{ margin:0; padding-left: 18px; }
    .lb li{
      margin: 6px 0;
      display:flex;
      justify-content:space-between;
      gap: 10px;
      font-weight: 700;
    }
    .muted{ opacity:.75; font-weight:600; }
    .warn{ margin-top:10px; opacity:.75; font-size:12px; line-height:1.3; }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      font-weight: 800;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="960" height="540" aria-label="Garlic Orbit Shooter"></canvas>

    <div id="uiOverlay" class="overlay">
      <div class="panel">
        <div>
          <div class="title">GARLIC ORBIT</div>
          <p class="sub">
            ‚Ä¢ Shoot üßÑ to gain <b>+1</b><br>
            ‚Ä¢ If üßÑ reaches bottom: <b>-1</b><br>
            ‚Ä¢ Touch red <b>U</b>: <b>-1 life</b><br>
            ‚Ä¢ Auto-shoot is ON ‚úÖ
          </p>

          <div class="row" style="margin-bottom:10px;">
            <span class="pill">Nickname</span>
            <input id="nameInput" maxlength="16" placeholder="Enter your nickname" />
            <button id="startBtn">Start</button>
          </div>

          <div class="row">
            <span class="pill">Your Best: <span id="bestInline">0</span></span>
            <span class="pill">Last Score: <span id="lastInline">0</span></span>
          </div>

          <div class="warn" id="apiWarn" style="display:none;">
            Leaderboard API not set or blocked. The game will still work, but online leaderboard may not update.
          </div>
        </div>

        <div class="lb">
          <h3>TOP 10 LEADERBOARD</h3>
          <ol id="lbList">
            <li><span class="muted">Loading...</span><span class="muted">--</span></li>
          </ol>
          <div class="warn muted">Tip: keep nicknames unique (max 16 chars).</div>
        </div>
      </div>
    </div>

    <div class="hint">
      <div>
        PC: <span class="kbd">A/D</span> or <span class="kbd">‚Üê/‚Üí</span> move,
        <span class="kbd">Space</span> start,
        <span class="kbd">R</span> restart
      </div>
      <div>
        Mobile: <span class="kbd">drag</span> to move, <span class="kbd">tap</span> to start
      </div>
    </div>
  </div>

<script>
(() => {
  // ====== SET THIS ======
  const LEADERBOARD_API_URL = "https://script.google.com/macros/s/AKfycbxeWe99syVgw7YVp2F7IUblgitt2vM10W_cYlSdeqvMrWSeavzyM9m3d-8VYADW8TV2vw/exec"; // <-- paste your Apps Script Web App URL here

  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");

  const overlay = document.getElementById("uiOverlay");
  const nameInput = document.getElementById("nameInput");
  const startBtn = document.getElementById("startBtn");
  const lbList = document.getElementById("lbList");
  const bestInline = document.getElementById("bestInline");
  const lastInline = document.getElementById("lastInline");
  const apiWarn = document.getElementById("apiWarn");

  const BEST_KEY = "garlic_orbit_best_v4";
  const NAME_KEY = "garlic_orbit_name_v1";

  const game = {
    w: 960, h: 540,
    running: false,
    over: false,
    lastTime: 0,

    score: 0,
    best: 0,
    lives: 5,

    spawnTimer: 0,
    spawnEvery: 650,

    enemyTimer: 0,
    enemyEvery: 5000,

    shootTimer: 0,
    shootCooldown: 160,

    difficultyTimer: 0,

    garlics: [],
    enemies: [],
    bullets: [],
    stars: [],

    input: {
      left: false, right: false,
      pointerDown: false,
      pointerX: 0,
      dragOffsetX: 0,
      dragging: false
    },

    playerName: "Player",
    submittedThisRun: false
  };

  const player = {
    x: 480, y: 500,
    speed: 520
  };

  function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

  function setupHiDPI() {
    const cssW = canvas.clientWidth;
    const cssH = canvas.clientHeight;
    const ratio = Math.max(1, Math.min(2.5, window.devicePixelRatio || 1));
    canvas.width = Math.floor(cssW * ratio);
    canvas.height = Math.floor(cssH * ratio);
    ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
    game.w = cssW;
    game.h = cssH;
  }

  function makeStars(n) {
    game.stars = [];
    for (let i = 0; i < n; i++) {
      game.stars.push({
        x: Math.random() * game.w,
        y: Math.random() * game.h,
        r: Math.random() * 1.8 + 0.3,
        v: Math.random() * 22 + 8
      });
    }
  }

  function loadLocal() {
    const best = Number(localStorage.getItem(BEST_KEY));
    game.best = Number.isFinite(best) ? best : 0;

    const nm = (localStorage.getItem(NAME_KEY) || "").trim();
    if (nm) game.playerName = nm.slice(0, 16);

    bestInline.textContent = game.best;
    lastInline.textContent = "0";
    nameInput.value = game.playerName;
  }

  function saveBestIfNeeded() {
    if (game.score > game.best) {
      game.best = game.score;
      localStorage.setItem(BEST_KEY, String(game.best));
      bestInline.textContent = game.best;
    }
  }

  function setOverlay(show) {
    overlay.classList.toggle("show", !!show);
  }

  function sanitizeName(name) {
    name = String(name || "").trim();
    name = name.replace(/[^\w\s\-\.]/g, "");
    if (name.length > 16) name = name.slice(0, 16);
    if (name.length < 2) name = "Player";
    return name;
  }

  async function apiGetLeaderboard() {
    if (!LEADERBOARD_API_URL) {
      apiWarn.style.display = "block";
      return;
    }
    try {
      const res = await fetch(`${LEADERBOARD_API_URL}?top=10`, { method: "GET" });
      const data = await res.json();
      if (!data || !data.ok) throw new Error("bad response");

      renderLeaderboard(data.rows || []);
      apiWarn.style.display = "none";
    } catch (e) {
      apiWarn.style.display = "block";
    }
  }

  async function apiSubmitScore(name, score) {
    if (!LEADERBOARD_API_URL) return;
    try {
      await fetch(LEADERBOARD_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, score })
      });
    } catch (e) {
      // ignore (offline / blocked)
    }
  }

  function renderLeaderboard(rows) {
    const safe = Array.isArray(rows) ? rows.slice(0, 10) : [];
    if (safe.length === 0) {
      lbList.innerHTML = `<li><span class="muted">No scores yet</span><span class="muted">--</span></li>`;
      return;
    }
    lbList.innerHTML = safe.map(r => {
      const n = sanitizeName(r.name);
      const s = Number(r.score);
      return `<li><span>${escapeHtml(n)}</span><span>${Number.isFinite(s) ? s : 0}</span></li>`;
    }).join("");
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));
  }

  function resetGame() {
    loadLocal();
    game.running = false;
    game.over = false;
    game.lastTime = 0;

    game.score = 0;
    game.lives = 5;

    game.spawnTimer = 0;
    game.spawnEvery = 650;

    game.enemyTimer = 0;
    game.enemyEvery = 5000;

    game.shootTimer = 0;
    game.shootCooldown = 160;

    game.difficultyTimer = 0;

    game.garlics = [];
    game.enemies = [];
    game.bullets = [];

    player.x = game.w / 2;
    player.y = game.h - 72;

    game.submittedThisRun = false;

    makeStars(80);
    setOverlay(true);
    apiGetLeaderboard();
  }

  function startGame() {
    if (game.over) return;

    // set nickname
    const nm = sanitizeName(nameInput.value);
    game.playerName = nm;
    localStorage.setItem(NAME_KEY, nm);

    setOverlay(false);

    game.running = true;
    requestAnimationFrame(loop);
  }

  function gameOver() {
    game.over = true;
    game.running = false;

    lastInline.textContent = game.score;
    saveBestIfNeeded();

    // submit once
    if (!game.submittedThisRun) {
      game.submittedThisRun = true;
      apiSubmitScore(game.playerName, game.score).then(apiGetLeaderboard);
    }

    setOverlay(true);
  }

  function loseLife() {
    game.lives -= 1;
    if (game.lives <= 0) gameOver();
  }

  function spawnGarlic() {
    const r = Math.random() * 18 + 22;
    const x = Math.random() * (game.w - r * 2) + r;
    const vy = Math.random() * 90 + 120 + (Math.max(0, game.score) * 0.20);
    const vx = (Math.random() - 0.5) * 90;
    game.garlics.push({ x, y: -r - 12, r, vy, vx });
  }

  function spawnEnemyU() {
    const w = Math.random() * 24 + 58;
    const h = Math.random() * 16 + 44;
    const x = Math.random() * (game.w - w) + w / 2;
    const vy = Math.random() * 70 + 110;
    const vx = (Math.random() - 0.5) * 60;
    game.enemies.push({ x, y: -h - 20, w, h, vy, vx });
  }

  function shoot() {
    const bx = player.x;
    const by = player.y - 22 - 10;
    game.bullets.push({ x: bx, y: by, r: 5, vy: 760 });
  }

  function circleRectHit(cx, cy, cr, rx, ry, rw, rh) {
    const closestX = clamp(cx, rx, rx + rw);
    const closestY = clamp(cy, ry, ry + rh);
    const dx = cx - closestX;
    const dy = cy - closestY;
    return (dx*dx + dy*dy) <= cr*cr;
  }

  function circleCircleHit(ax, ay, ar, bx, by, br) {
    const dx = ax - bx;
    const dy = ay - by;
    const rr = (ar + br) * (ar + br);
    return (dx*dx + dy*dy) <= rr;
  }

  function update(dt) {
    // stars
    for (const s of game.stars) {
      s.y += s.v * dt;
      if (s.y > game.h + 5) { s.y = -5; s.x = Math.random() * game.w; }
    }

    // player movement
    let dir = 0;
    if (game.input.left) dir -= 1;
    if (game.input.right) dir += 1;
    if (dir !== 0) player.x += dir * player.speed * dt;
    if (game.input.dragging) player.x = game.input.pointerX + game.input.dragOffsetX;
    player.x = clamp(player.x, 28, game.w - 28);

    // spawns
    game.spawnTimer += dt * 1000;
    if (game.spawnTimer >= game.spawnEvery) {
      game.spawnTimer = 0;
      spawnGarlic();
    }

    game.enemyTimer += dt * 1000;
    if (game.enemyTimer >= game.enemyEvery) {
      game.enemyTimer = 0;
      spawnEnemyU();
    }

    // difficulty (no visible timer)
    game.difficultyTimer += dt * 1000;
    if (game.difficultyTimer >= 1400) {
      game.difficultyTimer = 0;
      game.spawnEvery = clamp(game.spawnEvery - 18, 240, 900);
    }

    // AUTO FIRE
    game.shootTimer += dt * 1000;
    while (game.shootTimer >= game.shootCooldown) {
      game.shootTimer -= game.shootCooldown;
      shoot();
    }

    // bullets
    for (let i = game.bullets.length - 1; i >= 0; i--) {
      const b = game.bullets[i];
      b.y -= b.vy * dt;
      if (b.y < -40) game.bullets.splice(i, 1);
    }

    // garlics
    for (let i = game.garlics.length - 1; i >= 0; i--) {
      const g = game.garlics[i];
      g.y += g.vy * dt;
      g.x += g.vx * dt;
      if (g.x < g.r) { g.x = g.r; g.vx *= -1; }
      if (g.x > game.w - g.r) { g.x = game.w - g.r; g.vx *= -1; }

      // missed garlic => -1 score
      if (g.y > game.h + g.r + 20) {
        game.garlics.splice(i, 1);
        game.score -= 1;
      }
      // garlic touching player => no effect
    }

    // enemies U
    for (let i = game.enemies.length - 1; i >= 0; i--) {
      const e = game.enemies[i];
      e.y += e.vy * dt;
      e.x += e.vx * dt;

      const halfW = e.w / 2;
      if (e.x < halfW) { e.x = halfW; e.vx *= -1; }
      if (e.x > game.w - halfW) { e.x = game.w - halfW; e.vx *= -1; }

      // player hits U => -1 life
      const rx = e.x - e.w / 2;
      const ry = e.y - e.h / 2;
      if (circleRectHit(player.x, player.y, 22, rx, ry, e.w, e.h)) {
        game.enemies.splice(i, 1);
        loseLife();
        continue;
      }

      // U reaches bottom => no penalty
      if (e.y > game.h + e.h + 30) {
        game.enemies.splice(i, 1);
      }
    }

    // bullet collisions
    for (let bi = game.bullets.length - 1; bi >= 0; bi--) {
      const b = game.bullets[bi];

      // bullet hits U => remove bullet only (U stays)
      let used = false;
      for (let ei = game.enemies.length - 1; ei >= 0; ei--) {
        const e = game.enemies[ei];
        const rx = e.x - e.w / 2;
        const ry = e.y - e.h / 2;
        if (circleRectHit(b.x, b.y, b.r, rx, ry, e.w, e.h)) {
          game.bullets.splice(bi, 1);
          used = true;
          break;
        }
      }
      if (used) continue;

      // bullet hits garlic => +1 score
      for (let gi = game.garlics.length - 1; gi >= 0; gi--) {
        const g = game.garlics[gi];
        if (circleCircleHit(b.x, b.y, b.r, g.x, g.y, g.r)) {
          game.bullets.splice(bi, 1);
          game.garlics.splice(gi, 1);
          game.score += 1;
          break;
        }
      }
    }
  }

  function drawSpaceBg() {
    ctx.globalAlpha = 0.75;
    ctx.fillStyle = "rgba(255,255,255,0.95)";
    for (const s of game.stars) {
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2);
      ctx.fill();
    }
    ctx.globalAlpha = 1;

    const grad = ctx.createRadialGradient(game.w*0.55, game.h*0.15, 10, game.w*0.55, game.h*0.15, game.w*0.75);
    grad.addColorStop(0, "rgba(120,160,255,0.10)");
    grad.addColorStop(1, "rgba(0,0,0,0)");
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,game.w,game.h);
  }

  function drawPlayerMoney(x, y) {
    const r = 22;
    ctx.save();
    ctx.globalAlpha = 0.22;
    ctx.fillStyle = "rgba(80, 255, 150, 0.55)";
    ctx.beginPath(); ctx.arc(x, y, r + 14, 0, Math.PI*2); ctx.fill();
    ctx.restore();

    ctx.fillStyle = "rgba(40, 210, 110, 0.95)";
    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI*2); ctx.fill();

    ctx.fillStyle = "rgba(255,255,255,0.18)";
    ctx.beginPath(); ctx.arc(x - 7, y - 7, 8, 0, Math.PI*2); ctx.fill();

    ctx.fillStyle = "rgba(0,0,0,0.55)";
    ctx.font = "800 26px system-ui, sans-serif";
    ctx.textAlign = "center"; ctx.textBaseline = "middle";
    ctx.fillText("$", x, y + 1);

    ctx.strokeStyle = "rgba(120,255,180,0.45)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(x, y - r);
    ctx.lineTo(x, y - r - 18);
    ctx.stroke();
  }

  function drawGarlic(g) {
    ctx.fillStyle = "rgba(255, 245, 235, 0.16)";
    ctx.beginPath(); ctx.arc(g.x, g.y, g.r, 0, Math.PI*2); ctx.fill();
    ctx.font = `${Math.floor(g.r * 1.22)}px system-ui, Apple Color Emoji, Segoe UI Emoji`;
    ctx.textAlign = "center"; ctx.textBaseline = "middle";
    ctx.fillStyle = "white";
    ctx.fillText("üßÑ", g.x, g.y + 1);
  }

  function drawEnemyU(e) {
    const x = e.x, y = e.y, w = e.w, h = e.h;
    const left = x - w/2, right = x + w/2, top = y - h/2, bottom = y + h/2;
    const stroke = Math.max(6, Math.floor(w * 0.14));
    const radius = Math.min(w, h) * 0.24;

    ctx.save();
    ctx.globalAlpha = 0.22;
    ctx.lineWidth = stroke + 10;
    ctx.lineCap = "round"; ctx.lineJoin = "round";
    ctx.strokeStyle = "rgba(255,70,70,0.55)";
    ctx.beginPath();
    ctx.moveTo(left + radius, top + stroke*0.2);
    ctx.lineTo(left + radius, bottom - radius);
    ctx.arcTo(left + radius, bottom, left + radius + radius, bottom, radius);
    ctx.lineTo(right - radius - radius, bottom);
    ctx.arcTo(right - radius, bottom, right - radius, bottom - radius, radius);
    ctx.lineTo(right - radius, top + stroke*0.2);
    ctx.stroke();
    ctx.restore();

    ctx.save();
    ctx.lineWidth = stroke;
    ctx.lineCap = "round"; ctx.lineJoin = "round";
    ctx.strokeStyle = "rgba(255, 40, 40, 0.95)";
    ctx.beginPath();
    ctx.moveTo(left + radius, top + stroke*0.2);
    ctx.lineTo(left + radius, bottom - radius);
    ctx.arcTo(left + radius, bottom, left + radius + radius, bottom, radius);
    ctx.lineTo(right - radius - radius, bottom);
    ctx.arcTo(right - radius, bottom, right - radius, bottom - radius, radius);
    ctx.lineTo(right - radius, top + stroke*0.2);
    ctx.stroke();

    ctx.fillStyle = "rgba(255,255,255,0.10)";
    ctx.font = `700 ${Math.floor(h*0.22)}px system-ui, sans-serif`;
    ctx.textAlign = "center"; ctx.textBaseline = "middle";
    ctx.fillText("U", x, y);
    ctx.restore();
  }

  function drawBullets() {
    for (const b of game.bullets) {
      ctx.fillStyle = "rgba(140, 255, 190, 0.95)";
      ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = "rgba(140, 255, 190, 0.16)";
      ctx.beginPath(); ctx.arc(b.x, b.y, b.r + 6, 0, Math.PI*2); ctx.fill();
    }
  }

  function drawHUD() {
    // top-left: your best
    ctx.fillStyle = "rgba(255,255,255,0.92)";
    ctx.font = "700 18px system-ui, sans-serif";
    ctx.textAlign = "left"; ctx.textBaseline = "top";
    ctx.fillText(`YOUR BEST: ${game.best}`, 14, 12);

    // top-right: score
    ctx.textAlign = "right";
    ctx.fillText(`SCORE: ${game.score}`, game.w - 14, 12);

    // bottom-left lives as 5 garlic icons
    const baseX = 14, baseY = game.h - 14, size = 20;
    ctx.textAlign = "left";
    ctx.textBaseline = "alphabetic";
    ctx.font = `${size}px system-ui, Apple Color Emoji, Segoe UI Emoji`;
    for (let i = 0; i < 5; i++) {
      const x = baseX + i * (size + 6);
      ctx.globalAlpha = (i < game.lives) ? 1 : 0.25;
      ctx.fillText("üßÑ", x, baseY);
    }
    ctx.globalAlpha = 1;
  }

  function draw() {
    ctx.clearRect(0,0,game.w,game.h);
    drawSpaceBg();
    drawBullets();
    for (const g of game.garlics) drawGarlic(g);
    for (const e of game.enemies) drawEnemyU(e);
    drawPlayerMoney(player.x, player.y);
    drawHUD();
  }

  function loop(t) {
    if (!game.running) return;

    if (!game.lastTime) game.lastTime = t;
    const dt = Math.min(0.033, (t - game.lastTime) / 1000);
    game.lastTime = t;

    update(dt);
    draw();

    if (game.running) requestAnimationFrame(loop);
  }

  // UI events
  startBtn.addEventListener("click", startGame);
  nameInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") startGame();
  });

  // keyboard controls
  window.addEventListener("keydown", (e) => {
    if (e.code === "ArrowLeft" || e.code === "KeyA") game.input.left = true;
    if (e.code === "ArrowRight" || e.code === "KeyD") game.input.right = true;

    if (e.code === "Space") {
      e.preventDefault();
      if (!game.running) startGame();
    }

    if (e.code === "KeyR") {
      resetGame();
      draw();
    }
  });
  window.addEventListener("keyup", (e) => {
    if (e.code === "ArrowLeft" || e.code === "KeyA") game.input.left = false;
    if (e.code === "ArrowRight" || e.code === "KeyD") game.input.right = false;
  });

  // touch / pointer
  function getPointerPos(ev) {
    const rect = canvas.getBoundingClientRect();
    return { x: (ev.clientX - rect.left), y: (ev.clientY - rect.top) };
  }
  canvas.addEventListener("pointerdown", (ev) => {
    canvas.setPointerCapture(ev.pointerId);
    game.input.pointerDown = true;
    const p = getPointerPos(ev);
    game.input.pointerX = p.x;

    if (!game.running) startGame();

    const dx = p.x - player.x;
    const dy = p.y - player.y;
    if (Math.abs(dx) < 90 && Math.abs(dy) < 90) {
      game.input.dragging = true;
      game.input.dragOffsetX = player.x - p.x;
    }
  });
  canvas.addEventListener("pointermove", (ev) => {
    if (!game.input.pointerDown) return;
    const p = getPointerPos(ev);
    game.input.pointerX = p.x;
  });
  canvas.addEventListener("pointerup", () => {
    game.input.pointerDown = false;
    game.input.dragging = false;
  });

  // resize
  const ro = new ResizeObserver(() => {
    setupHiDPI();
    player.y = game.h - 72;
    draw();
  });
  ro.observe(canvas);

  // init
  loadLocal();
  setupHiDPI();
  resetGame();
  draw();
})();
</script>
</body>
</html>
